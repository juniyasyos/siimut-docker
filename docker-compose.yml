services:
  # ===== MySQL Database - Shared untuk semua project =====
  db:
    image: mysql:8.4
    container_name: base-db-mysql
    env_file:
      - .env.docker
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      # Databases akan dibuat via script atau manual
    command: ["--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci"]
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    ports:
      - "3307:3306"  # host:container
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===== Web Server (Caddy) - Shared untuk semua project =====
  web:
    image: caddy:2-alpine
    container_name: base-web
    ports:
      - "8080:8080"
      - "8081:8081"
      - "8082:8082"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./site/siimut-application:/var/www/siimut
      - ./site/laravel-iam:/var/www/iam
      - ./site/client-iiam:/var/www/client
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - app-siimut
      - app-iam
      - app-client
    restart: unless-stopped

  # ===== SI-IMUT Project =====
  app-siimut:
    build:
      context: ./site/siimut-application
      dockerfile: ../../docker/php/Dockerfile  
    container_name: siimut-app
    working_dir: /var/www/html
    user: root
    volumes:
      - ./site/siimut-application:/var/www/html
      - vendor_siimut:/var/www/html/vendor
    env_file:
      - .env.docker
    environment:
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      DB_DATABASE: ${DB_SIIMUT:-siimut}
      DB_USERNAME: ${DB_USER:-laravel}
      DB_PASSWORD: ${DB_PASSWORD:-laravel}
      DB_HOST: db
      DB_PORT: 3306
      DB_CONNECTION: mysql
    depends_on:
      - db
    restart: unless-stopped

  # ===== LARAVEL-IAM Project =====
  app-iam:
    build:
      context: ./site/laravel-iam
      dockerfile: ../../docker/php/Dockerfile  
    container_name: iam-app
    working_dir: /var/www/html
    user: root
    volumes:
      - ./site/laravel-iam:/var/www/html
      - vendor_iam:/var/www/html/vendor
    env_file:
      - .env.docker
    environment:
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      DB_DATABASE: ${DB_IAM:-laravel_iam}
      DB_USERNAME: ${DB_USER:-laravel}
      DB_PASSWORD: ${DB_PASSWORD:-laravel}
      DB_HOST: db
      DB_PORT: 3306
      DB_CONNECTION: mysql
    depends_on:
      - db
    restart: unless-stopped

  # ===== CLIENT-IIAM Project =====
  app-client:
    build:
      context: ./site/client-iiam
      dockerfile: ../../docker/php/Dockerfile  
    container_name: client-app
    working_dir: /var/www/html
    user: root
    volumes:
      - ./site/client-iiam:/var/www/html
      - vendor_client:/var/www/html/vendor
    env_file:
      - .env.docker
    environment:
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      DB_DATABASE: ${DB_CLIENT:-client_iiam}
      DB_USERNAME: ${DB_USER:-laravel}
      DB_PASSWORD: ${DB_PASSWORD:-laravel}
      DB_HOST: db
      DB_PORT: 3306
      DB_CONNECTION: mysql
    depends_on:
      - db
    restart: unless-stopped
  
  # ===== Node (Shared untuk build assets) =====
  node:
    image: node:alpine
    container_name: siimut-node
    working_dir: /var/www
    user: "1000:1000"
    volumes:
      - ./site/siimut-application:/var/www/siimut
      - ./site/laravel-iam:/var/www/iam
      - ./site/client-iiam:/var/www/client
    command: tail -f /dev/null
    restart: unless-stopped

volumes:
  mysql_data:
  caddy_data:
  caddy_config:
  vendor_siimut:
  vendor_iam:
  vendor_client:
