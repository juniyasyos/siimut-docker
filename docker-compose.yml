services:
  # ===== Web Server (Caddy) - Shared untuk semua project =====
  web:
    image: caddy:2-alpine
    container_name: siimut-web
    ports:
      - "8080:8080"
      - "8081:8081"
      - "8082:8082"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./site/siimut-application:/var/www/siimut
      - ./site/laravel-iam:/var/www/iam
      - ./site/client-iiam:/var/www/client
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - app-siimut
      - app-iam
      - app-client
    restart: unless-stopped

  # ===== SI-IMUT Project =====
  app-siimut:
    build:
      context: ./site/siimut-application
      dockerfile: ../../docker/php/Dockerfile  
    container_name: siimut-app
    working_dir: /var/www/html
    user: root
    volumes:
      - ./site/siimut-application:/var/www/html
      - vendor_siimut:/var/www/html/vendor
    env_file:
      - .env.docker
    environment:
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
    restart: unless-stopped

  # ===== LARAVEL-IAM Project =====
  app-iam:
    build:
      context: ./site/laravel-iam
      dockerfile: ../../docker/php/Dockerfile  
    container_name: iam-app
    working_dir: /var/www/html
    user: root
    volumes:
      - ./site/laravel-iam:/var/www/html
      - vendor_iam:/var/www/html/vendor
    env_file:
      - .env.docker
    environment:
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
    restart: unless-stopped

  # ===== CLIENT-IIAM Project =====
  app-client:
    build:
      context: ./site/client-iiam
      dockerfile: ../../docker/php/Dockerfile  
    container_name: client-app
    working_dir: /var/www/html
    user: root
    volumes:
      - ./site/client-iiam:/var/www/html
      - vendor_client:/var/www/html/vendor
    env_file:
      - .env.docker
    environment:
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
    restart: unless-stopped
  
  # ===== Node (Shared untuk build assets) =====
  node:
    image: node:alpine
    container_name: siimut-node
    working_dir: /var/www
    user: "1000:1000"
    volumes:
      - ./site/siimut-application:/var/www/siimut
      - ./site/laravel-iam:/var/www/iam
      - ./site/client-iiam:/var/www/client
    command: tail -f /dev/null
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
  vendor_siimut:
  vendor_iam:
  vendor_client:
